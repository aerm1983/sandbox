apiVersion: apps/v1
kind: Deployment
metadata:
  name: myimage-depl
  labels:
    app: myimage-label
spec:
  replicas: 1
  selector:
    matchLabels:
      app: myimage-label
  template:
    metadata:
      labels:
        # app: myimage-temp # does not work
        # app: myimage-depl # does not work
        app: myimage-label
    spec:
      containers:
      - name: myimagename
        image: local/myimage:0c
        # added because local image:
        imagePullPolicy: Never
        ports:
        - containerPort: 10000
        env:
        - name: __APP_USER_NAME__
          valueFrom:
            secretKeyRef:
              name: app-web-secret
              key: app-user-name
        - name: __APP_PASS_WORD__
          valueFrom:
            secretKeyRef:
              name: app-web-secret
              key: app-pass-word
        - name: __APP_OTHER_SERVICE_URL___
          valueFrom:
            configMapKeyRef:
              name: app-web-config
              key: app-other-service-url
      # added because local image:
      # restartPolicy: Never


---

apiVersion: v1
kind: Service
metadata:
  name: myimage-service
spec:
  # type: ClusterIP # default
  type: NodePort
  selector:
    app: myimage-label
    # app.kubernetes.io/name: MyApp
  ports:
    - protocol: TCP
      port: 10000
      targetPort: 10000
      nodePort: 30100

#
# (1) MINIKUBE, DEPLOY LOCALLY BUILT DOCKER IMAGES
# https://medium.com/swlh/how-to-run-locally-built-docker-images-in-kubernetes-b28fbc32cc1d
#
# add to deployment:  spec -> template -> spec -> containers -> imagePullPolicy : Never # OK
# add to deployment:  spec -> template -> spec -> restartPolicy : Never # suppressed, kubectl apply error message
#
# docker-cli points to default installation, it should be pointed to internal-minikube installation.
# preliminary checks, run: minikube info ; minikube profile list ; minikube options ; docker info | grep -i name ; docker image ls
# run: minikube --profile minikube docker-env # --profile also -p ; if profile 'minikube' is unique, this flag is not required
# run: eval $(minikube -p minikube docker-env)
#
# run again docker preliminary checks
#
# suggested aliases:
# run: alias mde="eval $( minikube --profile minikube docker-env )"
# run: alias mdeu="eval $( minikube --profile minikube docker-env | sed -E 's/export ([A-Z_]+)=.*/unset \1/g' )"
#
#
#
# (2) MINIKUBE, EXPOSE SERVICE (WINDOWS)
# https://stackoverflow.com/questions/60710171/minikube-ip-is-not-reachable
# create a deamon listening on 127.0.0.1:{new-assigned-port}, send to bg if convenient:
# run: minikube service myimage-service
#
#
#
#
