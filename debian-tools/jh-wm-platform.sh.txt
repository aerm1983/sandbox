#!/bin/bash
# JAVA HELPER WM PLATFORM
# dependencies: git-bash-aliases.sh, set-java-version.sh

__JH_WMP_UPDATED__='2022-10-11 10:03'
__JH_TIMEOUT_RETRY_SEC__=15
__JH_TIMEOUT_CONTINUE_SEC__=5


function _jh_kill_service {
    cdkj_s
    command cd ${1}
    pwd
    tk
    echo
}



function _jh_kill_platform {
    alias 1
    cdkj_s
    _jh_kill_service ui
    _jh_kill_service bulkfileprocessor
    _jh_kill_service productmanagement
    _jh_kill_service mailing
    _jh_kill_service mappingmanagement
    _jh_kill_service usermanagement
    _jh_kill_service marketplaceebay
    _jh_kill_service microservicesregistry
    cdkj_s
}



function _jh_start_service {
    cdkj_s
    command cd ${1}
    pwd
    jjr
    command cd ..
    # echo -n 'sleeping 40 secs... ' # original
    # sleep 40 # original
    # echo -e 'done\n' # original
    echo
    _jh_check_service_started ${1}
    echo
}



function _jh_check_service_started {
    cdkj_s
    command cd ${1}
    pwd
    while true ; do
	echo -n 'check '\'"${1}"\'' is started... '
        jjrg 'tomcat started' > /dev/null
	__check_ss__=${?}
	if [ ${__check_ss__} -eq '0' ] ; then
	    echo 'yes, wait '${__JH_TIMEOUT_CONTINUE_SEC__}' sec to continue... '
	    sleep ${__JH_TIMEOUT_CONTINUE_SEC__}
	    command cd ..
	    break
        else
	    echo 'no, retry in '${__JH_TIMEOUT_RETRY_SEC__}' sec'
	    sleep ${__JH_TIMEOUT_RETRY_SEC__}
	fi
    done
}



function _jh_start_platform {

    __date_ini=$( date )
    __uxt_ini=$( date +'%s' )

    alias 2
    cdkj_s
    sj8
    sleep ${__JH_TIMEOUT_CONTINUE_SEC__}




    # flyway clean
    # flyway baseline

    # mariadb_user='root'
    # mariadb_password='1234'
    # mariadb_db='bulkfileprocessor'

    # mariadb_sql_delete="DELETE FROM bulkfileprocessor.flyway_schema_history WHERE true ;"
    # mariadb_bash_delete='mariadb --database='\'${mariadb_db}\'' --user='\'${mariadb_user}\'' --password='\'${mariadb_password}\'' --vertical --execute='\'${mariadb_sql_delete}\'
    # echo "${mariadb_bash_delete}"
    # eval "${mariadb_bash_delete}"
    # echo $?

    # mariadb_sql_select="SELECT * FROM bulkfileprocessor.flyway_schema_history WHERE true ;"
    # mariadb_bash_select='mariadb --database='\'${mariadb_db}\'' --user='\'${mariadb_user}\'' --password='\'${mariadb_password}\'' --vertical --execute='\'${mariadb_sql_select}\'
    # echo "${mariadb_bash_select}"
    # eval "${mariadb_bash_select}"
    # echo $?

    # echo



    cdkj_s

    _jh_start_service microservicesregistry 

    _jh_start_service usermanagement
    _jh_start_service marketplaceebay
    _jh_start_service mappingmanagement
    # echo -n 'sleeping 40 secs... '
    # sleep 40
    # echo -e 'done\n'
    _jh_start_service mailing

    _jh_start_service productmanagement
    _jh_start_service bulkfileprocessor

    _jh_start_service ui

    cdkj_s



    # sleep 60 ; echo 'pre-curl, 60s pause 1, done'
    # sleep 30 ; echo 'pre-curl, 30s pause 2, done'
    # --location
    # curl -s -i --request POST --header 'Content-Type: application/json' --data-raw '{"filename": "ebay_product_test_4.9_ALBERTO.csv","job":"product","storeId":"do-commerce"}' --url 'http://localhost:8283/v1/event/ftp'
    # echo  'curl completed'
    # sleep 60 ; echo 'post-curl, 60s pause 1, done'

    
    __uxt_end=$( date +'%s' )
    let '__uxt_diff=__uxt_end-__uxt_ini' '__proc_min=__uxt_diff/60' '__proc_sec=__uxt_diff%60' 
    echo 'WM local deployment completed'
    echo 'start: '$( date -d '@'${__uxt_ini} )
    echo 'end:   '$( date -d '@'${__uxt_end} )
    echo 'total execution time (min:sec) -- '${__proc_min}':'${__proc_sec}

}



function _jh_clean_logs {
    cdk_s
    command cd log
    echo -n '' > microservices*.jar.log
    echo -n '' > usermanagement*.jar.log
    echo -n '' > marketplaceebay*.jar.log
    echo -n '' > mapping*.jar.log
    echo -n '' > mailing*.jar.log
    echo -n '' > productmanagement*.jar.log
    echo -n '' > bulk*.jar.log
    echo -n '' > ui*.jar.log
    clear ; echo 'refreshing...' ; sleep 1 ; clear ;
    alias 7
    pwd
    ll
    cdkj_s
    echo
}



alias 0='. ./jh-wm-platform.sh.txt ; echo "updated:" ${__JH_WMP_UPDATED__} ; 0p'
alias 0p='alias 0 ; echo ; alias 1 2 ; echo ; alias 7 ; echo ; alias 8 9 ;'
alias 1='_jh_kill_platform'
alias 2='_jh_start_platform'
alias 7='_jh_clean_logs'
alias 8='1 ; 7 ;    # kill, clean'
alias 9='1 ; 7; 2 ; # kill, clean, start'

